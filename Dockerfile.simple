# Dockerfile simplifi√© pour l'application VoD
# Version sans d√©pendances externes pour √©viter les probl√®mes de connectivit√©
FROM python:3.11-alpine

# M√©tadonn√©es
LABEL maintainer="Charles Pelong"
LABEL description="VoD Application with FastAPI and MinIO"
LABEL version="1.0"

# Variables d'environnement
ENV PYTHONUNBUFFERED=1
ENV PYTHONONDONTWRITEBYTECODE=1
ENV MINIO_ENDPOINT=minio:9000
ENV MINIO_ACCESS_KEY=admin
ENV MINIO_SECRET_KEY=admin123
ENV MINIO_SECURE=false
ENV MINIO_BUCKET=videos

# Cr√©er le r√©pertoire de travail
WORKDIR /app

# Installer les d√©pendances syst√®me minimales
RUN apk add --no-cache \
    curl \
    gcc \
    musl-dev \
    libffi-dev \
    openssl-dev

# Copier les requirements et installer les d√©pendances Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copier le code source
COPY main.py .
COPY static/ ./static/

# Cr√©er les r√©pertoires n√©cessaires
RUN mkdir -p /app/data /app/assets/qr_codes

# Exposer le port
EXPOSE 8000

# Script de d√©marrage simplifi√©
RUN echo '#!/bin/sh' > /app/start.sh && \
    echo 'echo "üöÄ D√©marrage de l'\''application VoD..."' >> /app/start.sh && \
    echo 'echo "‚è≥ Attente de MinIO..."' >> /app/start.sh && \
    echo 'until curl -f http://minio:9000/minio/health/live 2>/dev/null; do' >> /app/start.sh && \
    echo '  echo "MinIO n'\''est pas encore pr√™t, attente..."' >> /app/start.sh && \
    echo '  sleep 2' >> /app/start.sh && \
    echo 'done' >> /app/start.sh && \
    echo 'echo "‚úÖ MinIO est pr√™t !"' >> /app/start.sh && \
    echo 'echo "üé¨ D√©marrage du serveur FastAPI..."' >> /app/start.sh && \
    echo 'exec python main.py' >> /app/start.sh && \
    chmod +x /app/start.sh

# Point d'entr√©e
ENTRYPOINT ["/app/start.sh"]
